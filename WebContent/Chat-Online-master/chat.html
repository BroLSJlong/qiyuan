<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport"
          content="width-device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <title>Title</title>

    <link href="bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="dist/css/jquery-ui.min.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="fonts/custom-fonts.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="css/custom-styles.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="css/custom-global.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="css/custom-chat.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="css/animate.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="css/loaders.min.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="js/jquery-confirm/jquery-confirm.min.css" rel="stylesheet" type="text/css" charset="UTF-8"/>
    <link href="/qiyuan/Chat-Online-master/js/emojione.sprites.css"
          rel="stylesheet" type="text/css" media="screen">
	<!-- https://cdnjs.cloudflare.com/ajax/libs/emojione/1.5.2/assets/sprites/emojione.sprites.css -->
    <link href="dist/css/emojionearea.css" media="screen" rel="stylesheet" type="text/css">
</head>

<body class="transition-true">
<!-- 当前用户ID -->
<input type="hidden" id="UserId" value="1"/>

<!-- 当前用户名 -->
<input type="hidden" id="UserAccount" value="Earthshaking"/>

<!-- 当前用户密码 -->
<input type="hidden" id="UserPassword" value="12345"/>

<!-- 当前用户头像 -->
<input type="hidden" id="UserImg" value="img/user.jpg"/>

<!-- 页面加载效果 -->
<div id="loading" class="bg-main pb70">
    <i class="icon-spinner3 s32 color-white block loading"></i>
    <span class="loading-title block mt20 color-white">正在加载,请耐心等待...</span>
</div>

<div class="chat-content">

    <!-- 聊天区域 -->
    <div class="chat-body animated-slow bounceIn ">

        <!-- 左侧边栏 -->
        <div class="chat-left col-xs-3 col-sm-3 col-md-3 animated-slow" id="chatSidebar">
            <!-- 左侧边栏顶部搜索框 -->
            <div class="currentUser">
                <!--当前用户头像-->
                <a class="currentUserImg">
                    <img src="img/user.jpg" class="cursor-pointer" id="myImg">
                </a>
                <span class="currentUserAccount" id="UserName">Earthshaking</span>

                <div class="dropdown" id="usersDropdown">
                    <button class="btn btn-link a-none dropdown-toggle" data-toggle="dropdown">
                        <i class="icon-navicon s20"></i>
                    </button>
                    <ol class="dropdown-menu-right dropdown-menu p0 animated fadeInDown" role="menu">
                        <li><a class="p15 pt10 pb10 cursor-pointer" data-toggle="modal" href="../member-details-ljh.html"
                               >个人信息</a></li>

                        <li><a class="p15 pt10 pb10 cursor-pointer" data-toggle="modal"
                               data-target="#updateImg">修改头像</a></li>

                        <li><a href="../member-hwh.html" class="p15 pt10 pb10 cursor-pointer">关于本站</a></li>

                        <li><a class="p15 pt10 pb10 cursor-pointer" data-toggle="modal" onclick="goBack()"
                              >退出</a></li>
                    </ol>
                </div>

            </div>
            <!-- 分割线 -->
            <hr width="90%"
                style="margin:18px auto 5px;border:0.5px solid rgba(0,0,0,0.08);box-shadow: 0 1px 0px rgba(245,245,245,.6)"/>

            <div class="chat-left-top">
                <form class="form-inline chat-top-form per100">
                    <div class="form-group per100 search-group">
                        <i class="icon-search"></i>
                        <input class="form-control search-input per70 mr5 pull-left" type="text" placeholder="搜索"
                               id="search-friends">
                        <button class="btn addFriendBtn pull-right" title="添加好友" type="button" data-toggle="modal"
                                data-target="#addFriend"><i
                                class="icon-plus"></i></button>
                        <div class="clearfix"></div>
                    </div>
                </form>
            </div>
            <hr width="90%"
                style="margin:5px auto 0px;border:0.5px solid rgba(0,0,0,0.08);box-shadow: 0 1px 0px rgba(245,245,245,.6)"/>
            <!-- 好友列表 -->
            <ul class="friend-list" id="left-friend-list">
                <li>
                    <a class="a-none friend" href="javascript:void(null);">
                        <input class="friendId" type="hidden" value=""/>
                        <img src="img/img-1.jpg" class="users-img cursor-pointer img-circle">
                        <span class="friendName s15 strong">Friend 01</span>
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-link a-none dropdown-toggle" data-toggle="dropdown">
                            <i class="icon-dots-horizontal-triple s20"></i>
                        </button>
                        <ol class="dropdown-menu-right dropdown-menu p0 animated fadeInDown" role="menu">
                            <li><a class="p15 pt10 pb10 cursor-pointer deleteFriendBtn" data-toggle="modal"
                                   data-target="#confirmDelete">删除好友</a></li>
                        </ol>
                    </div>
                </li>
				
                <li id="notResult" style="display: none;">
                    <span class="text-center block pt25 pb25 s15"
                          style="border-bottom: 1px solid rgba(102,102,102,0.1);">没有搜索到内容...</span>
                </li>
            </ul>
        </div>

        <!-- 右侧聊天窗口 -->
        <div class="chat-right">

            <!--  -->
            <div class="chat-right-top">
                <button class="btn btn-link a-none" id="sidebarBtn">
                    <i class="icon-navicon s20"></i>
                </button>
                <h4 class="chat-title">
                    <i class="icon-bubbles4 mr5"></i>
                    <span id="current-friend">聊天窗口</span>
					<input type="hidden" id="current-friendId">
					<input type="hidden" id="current-friendimgId">
                </h4>
                <button type="button" class="close" onclick="goBack()" id="ifm-close">&times;</button>
            </div>

            <!-- 消息显示 -->
            <div class="chat-show my-panel-diy" id="messages">

                <!-- 自己发的消息 -->
                <div class="my-msg per100 animated fadeInUp msg">
                    <span class="my-msg-qipao">嘿</span>
                    <img src="img/poster-about.jpg" class="users-img cursor-pointer ml20 img-circle">
                    <input class="NowTime" value="2018/07/01 07:15:59" type="hidden"/>
                </div>

                <div class="my-msg per100 animated fadeInUp msg">
                    <span class="my-msg-qipao">最近还好吗？</span>
                    <img src="img/poster-about.jpg" class="users-img cursor-pointer ml20 img-circle">
                    <input class="NowTime" value="2018/07/01 07:18:59" type="hidden"/>
                </div>

                <!-- 对方发的消息 -->
                <div class="friend-msg per100 animated fadeInDown msg">
                    <img src="img/img-1.jpg" class="users-img mr20 cursor-pointer img-circle">
                    <span class="friend-msg-qipao">嗯？我们认识吗？</span>
                    <input class="NowTime" value="2018/07/01 08:21:59" type="hidden"/>
                </div>

                <!-- 自己发的消息 -->
                <div class="my-msg per100 animated fadeInUp msg">
                    <span class="my-msg-qipao">可以认识一下</span>
                    <img src="img/poster-about.jpg" class="users-img cursor-pointer ml20 img-circle">
                    <input class="NowTime" value="2018/07/05 06:12:59" type="hidden"/>
                </div>

                <div class="friend-msg per100 animated fadeInDown msg">
                    <img src="img/img-1.jpg" class="users-img mr20 cursor-pointer img-circle">
                    <span class="friend-msg-qipao">噢，那很高兴认识你。</span>
                    <input class="NowTime" value="2018/07/08 08:18:59" type="hidden"/>
                </div>



            </div>
            <!-- 输入消息区域 -->
            <div class="chat-input">
                <form class="chat-form" role="form" action="#" method="post">
                    <div class="form-group m0">
                        <!-- 输入消息的文本域 -->
                        <textarea id="chat-textarea" class="form-control" maxlength="300"></textarea>
                    </div>
                    <div class="form-group m0 pr15 pb15 pt5 white-bg relative">
                        <!-- 发送消息的按钮 -->
                        <span class="alertTips">不能发送空的消息</span>
                        <button type="button" id="sendMsgBtn" class="btn btn-default pull-right">发送(s)</button>
                        <div class="clearfix"></div>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<!-- 添加好友模态框 -->
<div class="modal fade" id="addFriend" tabindex="-1" aria-hidden="false"
     role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" style="width: 450px;margin-top: 100px;">
        <div class="modal-content " style="overflow: hidden">
            <div class="modal-header gray-bg pl10 pb10 pt10">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title s14"><i class="icon-uniF071 mr5 s15"></i>添加好友</h4>
            </div>
            <div class="modal-body text-center pt25">
                <form class="search-friend">
                    <div class="form-group relative">
                        <i class="icon-search mySearch"></i>
                        <input class="form-control" type="text" placeholder="搜索朋友" id="search-users">
                    </div>
                    <p class="pt10 pb10 s13 gray-bg m0 btlr btrr search-result-title">搜索结果</p>
                    <div class="form-group search-result-wrap bbrr bblr my-panel-diy" style="height: 380px">

                        <ul class="friend-list" style="height: auto;" id="searchUsersResult">

                            <li id="nullSearchResult">
                                <span class="text-center block pt25 pb25 s15" style="color: rgba(0,0,0,0.63);">请输入您要搜索的用户</span>
                            </li>
                            <!-- <li><a class="a-none" href="javascript:void(null);">
                            <img src="img/img-1.jpg" class="users-img cursor-pointer img-circle">
                            <span class="friendName s15 strong">Friend 01</span>
                            <button class="btn white-bg btn-sm addBtns" type="button">添加</button>
                            </a></li> -->
                        </ul>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 确认是否删除好友模态框 -->
<div class="modal fade" id="confirmDelete" tabindex="-1" aria-hidden="false"
     role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" style="width: 350px;margin-top: 200px;">
        <div class="modal-content " style="overflow: hidden">
            <div class="modal-header alert-danger pl10 pb10 pt10">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title s14"><i class="icon-warning mr5 s15"></i>警告</h4>
            </div>
            <div class="modal-body text-center pt25">
                <form id="deleteFriend-form">
                    <p class="pt15 pb15 s16 flex-center">
                        <!-- 将要删除的好友用户名 -->
                        <input type="hidden" id="DeleteFriendAccount" value="">
                        <input type="hidden" id="myAccount" value="">
                        <input type="hidden" id="myFriendId" value="">
                        <strong class="modal-alert text-left" id="marked">
                            确定要删除这个好友吗?
                        </strong>
                    </p>
                    <div class="form-group mb5 mt15">
                        <button class="btn btn-default per25" data-dismiss="modal" type="button">取消</button>
                        <button class="btn btn-danger per25" data-dismiss="modal" type="button" id="yesDelete" onclick="deleteFriend()">确认</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 修改头像模态框 -->
<div class="modal fade" id="updateImg" tabindex="-1" aria-hidden="false"
     role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" style="width: 650px;margin-top: 100px;">
        <div class="modal-content " style="overflow: hidden">
            <div class="modal-header gray-bg pl10 pb10 pt10">
                <button class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title s14"><i class="icon-image mr5 s15"></i>修改头像</h4>
            </div>
            <div class="modal-body">
                <ul class="img-list lightgray-bg b my-panel-diy">
                    <li>
                        <a href="javascript:void(null);">
                            <input type="radio" class="hide" value="img/img-7.jpg" name="checkImg">
                            <img class="cursor-pointer img-rounded" id="previewImg" width="70px" height="70px" src="img/user.jpg">
                        </a>
                    </li>
                </ul>
                <div class="form-group mb5 mt15 text-right">
                    
					<form enctype="multipart/form-data" name="imgForm" style="width: 320px;float: left;">
						<input type="file" id="image-file" name="img" accept="image/*" onchange="selectImg()" />
					</form>
					<button class="btn btn-default per15 mr10" data-dismiss="modal" type="button">取消</button>
					<button class="btn btn-dark per15" type="button" data-dismiss="modal" id="yesUpdate" onclick="changeImg()">确认</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="js/jquery-2.1.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="bootstrap-3.3.7-dist/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
<script src="dist/js/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/custom-scripts.js" type="text/javascript" charset="utf-8"></script>
<script src="js/mustache.js" type="text/javascript" charset="utf-8"></script>
<script src="js/jquery-confirm/jquery-confirm.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript"
        src="/qiyuan//Chat-Online-mastre/js/emojione.min.js"></script>
		<!-- https://cdnjs.cloudflare.com/ajax/libs/emojione/1.5.2/lib/js/emojione.min.js -->
<script type="text/javascript" src="dist/js/emojionearea.min.js"></script>
<script>
    // 页面全部加载完成后 loading动画消失
    window.onload = function () {
        setTimeout(function () {
            $("#loading").fadeOut();
        }, 1200);
    };
	
	function selectImg(){
		var imgURL = getObjectURL(document.getElementById("image-file").files[0]);
		$("#previewImg").attr("src",imgURL);
	}
	
	function getObjectURL(file) {
		var url = null ;
		if (window.createObjectURL!=undefined) { // basic
			url = window.createObjectURL(file) ;
		} else if (window.URL!=undefined) { // mozilla(firefox)
			url = window.URL.createObjectURL(file) ;
		} else if (window.webkitURL!=undefined) { // webkit or chrome
			url = window.webkitURL.createObjectURL(file) ;
		}
		return url ;
	}
	
	function changeImg(){
		
		$.ajax({
			type:"post",
			url:"/qiyuan/UserController/changeHeadImg.do?idCard="+user.idCard,
			data:new FormData(imgForm),
			processData: false,
			contentType: false,
			success:function(imgId){
						if(imgId!= null && imgId!= ""){
						user.imgId = imgId;
						imgId = "/qiyuan/imgs/"+user.imgId;
						$("#myImg").attr("src",imgId);
						sessionStorage.setItem("user",JSON.stringify(user));
						$("#userInfoImg").attr('src', imgId);
						thisUser.img = imgId;
						$(".my-msg").find(".users-img").attr("src",imgId);
						}else{
							alert("图片只支持jpg,jpeg,png格式！");
						}
					}
		});
		
	}

    function deleteFriend(){
		$.post("/qiyuan/FriendController/deleteById.do",{"idCard":user.idCard,"fIdCard":$("#myFriendId").val()},function(b){
			if(b){
				$("#left-friend-list").find("input[value='"+$("#myFriendId").val()+"']").parents("li").remove();
				for(var i = 0; i < friends.length; i++){
					if(friends[i].idCard == $(myFriendId).val()){
						friends.splice(i);
					}
				}
			}else alert("删除失败");
		})
    }
    
	function addFriend(friend){
		if(friend == 'myself'){
			alert("这是你自己啊！！");
		}else if(friend != '已添加'){
			$.post("/qiyuan/FriendController/add.do",{"fIdCard":friend.idCard,"idCard":user.idCard},function(b){
				if(b){
					appendFriend(friend);
					initFriends();
					friends.push(friend);
					$("#"+friend.idCard).text("已添加");
				}else{
					alert("添加失败");
				}
			});
		}
	}
	
	function initWebSocket(){
		var sURL = "ws://"+"112.74.44.198:8080"+"/qiyuan/WebSocketController/"+user.idCard;
		myWebSocket = new WebSocket(sURL);
		//连接成功
		myWebSocket.onopen = function(){
			console.log("连接成功");
		}
		//接收消息
		myWebSocket.onmessage = function(evt){
			var targetId = evt.data.substring(0,18);
			if(targetId == $("#current-friendId").val()){
				addTargetMessage(evt.data.substring(36));
				saveHistory('1',evt.data.substring(36));
			}else if(targetId != user.idCard){
				saveOtherHistory(evt.data.substring(36),targetId);
			}else{
				$.post("/qiyuan/MessageController/add.do",{
					'idCard':evt.data.substring(18,36),
					'messageIdCard':user.idCard,
					'message':evt.data.substring(36)});
			}
			
		}
	}
	//显示对面发送信息
	function addTargetMessage(message){
		node = '<div class="friend-msg per100 animated fadeInDown msg">' +
					'<img src="'+$("#current-friendimgId").val()+'" class="users-img mr20 cursor-pointer img-circle">' +
					'<span class="friend-msg-qipao">' + message + '</span>' +
					'<input class="NowTime" value="" type="hidden"/>' +
				'</div>';
		$("#messages").append(node);
	}
	//显示自己发送信息
	function addMyMessage(message){
		node = '<div class="my-msg per100 animated fadeInUp msg">'+
                    '<span class="my-msg-qipao">'+message+'</span>'+
                    '<img src="/qiyuan/imgs/'+user.imgId+'" class="users-img cursor-pointer ml20 img-circle">'+
                    '<input class="NowTime" value="" type="hidden"/>' +
                '</div>';
		$("#messages").append(node);
	}
	//发送消息
	function wsSendMessage(message){
		message = user.idCard + $("#current-friendId").val() + message;
		myWebSocket.send(message);
	}
	//读取历史信息
	function readHistory(){
		myHistory = JSON.parse(localStorage.getItem(user.idCard+$("#current-friendId").val()));
		if(myHistory == null || myHistory == ""){
			myHistory = new Array();
		}else{
			for(var i = 0; i < myHistory.length; i++){
				if(myHistory[i].substring(0,1) == '0'){
					addMyMessage(myHistory[i].substring(1));
				}else{
					addTargetMessage(myHistory[i].substring(1));
				}
			}
		}
	}
	//保存历史信息
	function saveHistory(who,message){
		myHistory.push(who+message);
		localStorage.setItem(user.idCard+$("#current-friendId").val(),JSON.stringify(myHistory));
	}
	
	function saveOtherHistory(message,targetId){
		var keyName = user.idCard+targetId;
		var otherHistory = JSON.parse(localStorage.getItem(keyName));
		if(otherHistory == null || otherHistory == ""){
			otherHistory = new Array();
		}
		otherHistory.push('1'+message);
		localStorage.setItem(keyName,JSON.stringify(otherHistory));
	}
	//获取留言信息
	function getOfflineMessage(){
		$.post("/qiyuan/MessageController/list.do",{'idCard':user.idCard},function(list){
			console.log(list);
			for(var i = 0; i < list.length; i++){
				saveOtherHistory(list[i].message,list[i].messageIdCard);
			}
		})
	}
	
	function goBack(){
		window.history.back();
	}
		
	function toFriend(idCard,m){
		var fuser;
		if(m == 'friend'){
			for(var i = 0; i < friends.length; i++){
				if(friends[i].idCard == idCard){
					fuser = friends[i];
					break;
				}
			}
		}else {
			for(var i = 0; i < searchUs.length; i++){
				if(searchUs[i].idCard == idCard){
					fuser = searchUs[i];
					break;
				}
			}
		}
		sessionStorage.setItem("friend",JSON.stringify(fuser));
		location = "/qiyuan/member-details-friend.html";
	}	
		
    $(function () {
        $(document).tooltip();
        // 当前登录的用户 构造函数
        var currentUser = function (id, account, password, img) {
            var person = {
                id: id,
                name: account,
                password: password,
                img: img
            };
            return person;
        };
		user = JSON.parse(sessionStorage.getItem("user"));
        var uid = user.idCard; // 当前用户id
        var uaccount = user.userName; // 当前用户名
        var uimg = "/qiyuan/imgs/"+user.imgId; // 当前用户头像
        var upassword = user.pwd; // 当前用户头像
		$("#myImg").attr("src","/qiyuan/imgs/"+user.imgId);
		$("#UserName").text(user.userName);
		
        // 封装当前登录的用户
		
        thisUser = currentUser(uid, uaccount, upassword, uimg);
        $("#userInfoImg").attr('src', thisUser.img);
        $("#userInfoAccount").text(thisUser.name);
        $("#userInfoPassword").val(thisUser.password);

        var chatShow = $(".chat-show");

        // 表情插件初始化
        $("#chat-textarea").emojioneArea({
            template: "<filters/><tabs/><editor/>",
            autoHideFilters: false
        });

        // 按回车键发送信息
        $(".emojionearea-editor").keydown(function (e) {
            if (event.keyCode == "13") {//keyCode=13是回车键
                e.preventDefault();
                $("#sendMsgBtn").click();
            }
        });

        // 当前的日期与时间
        var nowTime = function (date) {
            var Y = date.getFullYear();  // 年
            var M = date.getMonth() + 1; // 月
            var D = date.getDate();      // 日
            var h = date.getHours();     // 时
            var m = date.getMinutes();   // 分
            var s = date.getSeconds();   // 秒

            var nowDate = Y + "-" + M + "-" + D + " " + h + ":" + m + ":" + s;
            return nowDate;
        };

        // 点击发送信息
        $("#sendMsgBtn").click(function () {
            var mydate = new Date();// 时间
            var nowtimes = nowTime(mydate);
            // var msgVal = $("#chat-textarea").val();

            var msgVal = $(".emojionearea-editor").html();
            var msgNode = "";

            if (msgVal != "" && myWebSocket != null) {

                // 生成发送的消息
                msgNode += "<span class='my-msg-qipao'>" + msgVal + "</span>" +
                    "       <img src='" + thisUser.img + "' class='users-img cursor-pointer ml20 img-circle'>" +
                    "       <input class='NowTime' value='" + nowtimes + "' type='hidden'/>";

                // 生成发送的消息的div
                var msgNodeDiv = "<div class='my-msg per100 animated fadeInUp msg'>" + msgNode + "</div>";

                chatShow.append(msgNodeDiv);// 添加到会话窗口
                var scrollTopPx = $(".chat-show")[0].scrollHeight;
                chatShow.animate({scrollTop: scrollTopPx}, 500); // 会话窗口滚动到最底部
                $(".emojionearea-editor").html("");// 清空会话窗口
				saveHistory('0',msgVal);
				wsSendMessage(msgVal);
            } else {

                // 显示不可发送空消息的提示
                $(".alertTips").fadeIn();
                setTimeout(function () {
                    $(".alertTips").fadeOut();
                }, 2000);
				
            }
        });


        // 好友列表
        // var friends = [
        //     {id: 1, img: "img/img-1.jpg", name: "张三"},
        //     {id: 2, img: "img/img-2.jpg", name: "李四"},
        //     {id: 3, img: "img/img-3.jpg", name: "王五"},
        //     {id: 4, img: "img/img-4.jpg", name: "赵孙"},
        //     {id: 5, img: "img/img-5.jpg", name: "小强"},
        //     {id: 6, img: "img/img-3.jpg", name: "武松"}
        // ];
		appendFriend = function(friend){
			// 初始化所有好友
			friendNode = "<li><a class=\"a-none friend\" href=\"javascript:void(null);\">\n" +
				"                    <input class=\"friendId\" type=\"hidden\" value=\"" + friend.idCard + "\"/>\n" +
				"                    <img src=\"/qiyuan/imgs/" + friend.imgId + "\" class=\"users-img cursor-pointer img-circle\"/>\n" +
				"                    <span class=\"friendName s15 strong\">" + friend.realName + "</span>\n" +
				"                </a>\n" +
									"	<div class=\"dropdown\">\n" + 
									"		<button class=\"btn btn-link a-none dropdown-toggle\" data-toggle=\"dropdown\" aria-expanded=\"false\">\n" +
									"			<i class=\"icon-dots-horizontal-triple s20\"></i>\n" +
									"		</button>\n" +
									"		<ol class=\"dropdown-menu-right dropdown-menu p0 animated fadeInDown\" role=\"menu\">\n" +
									"			<li><a class=\"p15 pt10 pb10 cursor-pointer deleteFriendBtn\" data-toggle=\"modal\"\n" +
									"			data-target=\"#confirmDelete\">删除好友</a></li>\n" +
									"			<li><a class=\"p15 pt10 pb10 cursor-pointer deleteFriendBtn\" data-toggle=\"modal\"\n" +
									'			onclick="toFriend(\''+friend.idCard+'\',\'friend\')">信息详情</a></li>\n' +			
									"		</ol>\n" +
									"	</div>\n</li>";
				
				$("#left-friend-list").append(friendNode);
		}
		
        window.console.log(user);
		friends = new Array();
		listFriend = function(){
			$("#left-friend-list").empty();
			$.post("/qiyuan/FriendController/list.do",{"idCard":user.idCard},function(listId){
			index = 0;
			if(listId != null && listId.length != 0){
				for(var i = 0; i < listId.length; i++){
					$.post("/qiyuan/UserController/selectUser.do",{"idCard":listId[i].fIdCard},function(friend){
						friends.push(friend[0]);
						index++;
						appendFriend(friend[0]);
						if(listId.length == friends.length){
							initModel();
						}
					}
					,"json");}
			}else{
				initModel();
			}
			}
			);
		}
		initWebSocket();
		getOfflineMessage();
		listFriend();
		initModel = function(){
			
			//初始化聊天窗口
			if(friends != null && friends.length != 0){
				$('#current-friend').text(friends[0].realName);
				$("#current-friendId").val(friends[0].idCard);
				$("#left-friend-list").find("input[value='"+friends[0].idCard+"']").parents('a.friend').addClass('active');
				$("#current-friendimgId").val("/qiyuan/imgs/"+friends[0].imgId);
				$("#messages").html("");
				readHistory();
			}
			// 搜索用户框
			var searchUsers = $("#search-users");
			// 搜索好友框
			var searchFriends = $("#search-friends");
			
			// 搜索好友
			searchFriends.keyup(function () {
			    var queryStr = $(this).val(); // 搜索框内输入的值
			
			    // 获取搜索结果的长度
			    var resultSize = $("#left-friend-list > li").hide().find(".friendName").filter(":contains('" + queryStr + "')").size();
			
			    if (resultSize > 0) {
			        // 搜索结果的长度 > 0  搜索结果不为空
			        $("#left-friend-list > li").hide().find(".friendName").filter(":contains('" + queryStr + "')").parent('a').parent('li').show();
			    } else {
			        // 搜索结果的长度 <= 0  搜索结果为空
			        $("#left-friend-list > li:not(#notResult)").hide();
			        $("#left-friend-list > li#notResult").show();
			    }
			
			});
			
			// 搜索用户
			searchUsers.keyup(function () {
			    // 搜索不到内容时显示的元素
			    var noSearchResult = "<li id='notSearchResult'>" +
			        "                      <span class='text-center block pt25 pb25 s15' style='border-bottom:1px solid rgba(102,102,102,0.08);color: rgba(0,0,0,0.63);'>用户不存在...</span>" +
			        "                 </li>";
			    // 搜索的值为空时显示的元素
			    var nullSearchResult = "<li id='nullSearchResult'>" +
			        "                      <span class='text-center block pt25 pb25 s15' style='color: rgba(0,0,0,0.63);'>请输入您要搜索的用户</span>" +
			        "                 </li>";
			
			    var searchUsersResult = $("#searchUsersResult");
				$("#searchUsersResult").empty();
				if($("#search-users").val() != ""){
					$.post("/qiyuan/UserController/selectUser.do",{"userName":$("#search-users").val()},function(userList){
						searchUs = userList;
						$("#searchUsersResult").empty();
						if(userList != "" && userList != null){
							for(var i = 0; i < userList.length; i++){
								var x = userList[i];
								//判断是不是好友
								var isFriend = "添加";
								var searchUserMessage = "{'imgId':'"+x.imgId+"','realName':'"+x.realName+"','idCard':'"+x.idCard+"'}";
								if(x.idCard == user.idCard){
									isFriend = "信息详情";
									searchUserMessage = "'myself'";
								}
								if(friends != null && friends.length != 0){
									for(var j = 0; j < friends.length; j++){
										if(x.idCard == friends[j].idCard){
											isFriend = "已添加";
											searchUserMessage = "'已添加'";
											break;
										}
									}
								}
								// 生成元素
								node = "<a class=\"a-none\" href=\"javascript:void(null);\">\n" +
								    "                                <img src=\"/qiyuan/imgs/" + x.imgId + "\" class=\"users-img cursor-pointer img-circle\" onclick=\"toFriend('"+x.idCard+"','search')\">\n" +
								    "                                <span class=\"friendName s15 strong\">" + x.userName + "</span>\n" +
								    "                                <button id=\""+x.idCard+"\" class=\"btn white-bg btn-sm addBtns\" type=\"button\" data-toggle=\"modal\" data-target=\"#addFriendOk\" onclick=\"addFriend("+searchUserMessage+")\">"+ isFriend +"</button>\n" +
								    "                            </a>\n";
								var mynode = "<li>" + node + "</li>";
								// 添加节点 显示在页面上
								searchUsersResult.append(mynode);
							}
						}else {
							$("#searchUsersResult").empty();
							$("#searchUsersModal").empty(); // 如果返回值为空就清空搜索结果
							searchUsersResult.append(noSearchResult);
					    }
					})
				}else{
					$("#searchUsersResult").empty();
					searchUsersResult.append(nullSearchResult);
				}
			});
			
			initFriends =  function(){
				// 点击左侧好友列表
				$(".chat-left").find("#left-friend-list li").click(function () {
				    $(this).find('a.friend').addClass('active');// 添加点击效果
				
				    var currentFriend = $(this).find('.friendName').text(); // 获取点击的好友用户名
				
				    $('#current-friend').text(currentFriend); // 添加到聊天窗口顶部标题处
				
				    chatShow.html(""); // 刷新/清空聊天窗口
				
				    $(this).siblings().children('a.friend').removeClass('active');
					
					$("#current-friendId").val($(this).find("input.friendId").val());
					
					$("#current-friendimgId").val($(this).find("img.users-img").attr("src"));
					
					readHistory();
				});
				
				// 点击删除好友
				$(".deleteFriendBtn").on("click", function () {
				    var friendNames = $(this).parents('li').find('.friendName').text();
				    var friendId = $(this).parents('li').find('.friendId').val();
				    $("#marked").text("确定要删除好友 "+friendNames+" 吗?");
				    $("#DeleteFriendAccount").val(friendNames);
				    $("#myAccount").val(thisUser.name);
				    $("#myFriendId").val(friendId);
				});
			}
			
			initFriends();
			
			// 修改头像 选择头像
			$(".img-list li").find('a').on("click", function () {
			    $(this).find("input[name='checkImg']").prop('checked', 'true');
			    $(this).addClass('active');
			    $(this).parent().siblings().find('a').removeClass('active');
			});
			
			// 获取消息
			var getMsg = function () {
			    console.log("获取消息...");
			};
			
			// 消息根据时间排序
			var msgSort = function () {
			    var lis = [];
			    lis = $(".msg");
			
			    var ux = [];
			
			    // 循环提取时间，调用排序方法进行排序
			    for (var i = 0; i < lis.length; i++) {
			        var tmp = {};
			        tmp.dom = lis.eq(i);
			        tmp.date = new Date(lis.eq(i).find(".NowTime").val().replace(/-/g, '/'));
			        ux.push(tmp);
			    }
			
			    // 数组排序，支持年的比较
			    ux.sort(function (a, b) {
			        var myDate = new Date();
			        var year = myDate.getYear();
			
			        if (a.date.getYear < year && b.date.getYear == year) {
			            return true;
			        }
			        return a.date - b.date;
			    });
			
			    // 移除原先顺序错乱的内容
			    chatShow.empty();
			
			    // 重新添加排序好的内容
			    for (var q = 0; q < ux.length; q++) {
			        chatShow.append(ux[q].dom);
			    }
			
			
			};
			
			msgSort();
			
			$("#sidebarBtn").on("click", function (e) {
			    $("#chatSidebar").removeClass('bounceOutLeft').addClass('bounceInLeft').show();
			
			    $(document).on("click", function () {
			        if ($("#chatSidebar").hasClass('bounceInLeft')) {
			            $("#chatSidebar").removeClass('bounceInLeft').addClass('bounceOutLeft').hide();
			        }
			    });
			    
			});
		}
						
    });
</script>
</body>
</html>